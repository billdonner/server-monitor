<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Server Monitor</title>
<style>
  /* ── Theme variables (matches Textual dark/light) ── */
  :root {
    --cols: 2;
  }
  [data-theme="dark"] {
    --bg: #1e1e1e;
    --surface: #121212;
    --panel: #282828;
    --card-border: #004578;
    --card-border-dim: #333;
    --text: #e0e0e0;
    --text-bold: #fff;
    --dim: #6f6f6f;
    --primary: #004578;
    --accent: #0178d4;
    --green: #3bc55b;
    --red: #e24c5e;
    --yellow: #e2c252;
    --cyan: #24c8db;
    --magenta: #c87adb;
    --blue: #4488ff;
    --white: #e0e0e0;
    --header-bg: #0178d4;
    --header-text: #fff;
    --footer-bg: #282828;
    --footer-text: #e0e0e0;
    --footer-key-bg: #e0e0e0;
    --footer-key-text: #282828;
  }
  [data-theme="light"] {
    --bg: #f5f5f5;
    --surface: #fff;
    --panel: #fff;
    --card-border: #0178d4;
    --card-border-dim: #ccc;
    --text: #1e1e1e;
    --text-bold: #000;
    --dim: #888;
    --primary: #0178d4;
    --accent: #004578;
    --green: #1a8a35;
    --red: #c22535;
    --yellow: #a88b15;
    --cyan: #0c8a96;
    --magenta: #9530a8;
    --blue: #2060cc;
    --white: #1e1e1e;
    --header-bg: #0178d4;
    --header-text: #fff;
    --footer-bg: #e8e8e8;
    --footer-text: #333;
    --footer-key-bg: #333;
    --footer-key-text: #e8e8e8;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'Menlo', 'Consolas', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ── Header / Status Banner ── */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 20px;
    background: var(--header-bg);
    color: var(--header-text);
    font-size: 14px;
    font-weight: 600;
    min-height: 36px;
    transition: background 0.4s ease;
  }
  .header.status-ok {
    background: var(--green);
  }
  .header.status-error {
    background: var(--red);
  }
  .header .status-detail {
    font-weight: 400;
    font-size: 12px;
    opacity: 0.95;
    margin-left: 12px;
  }
  .header .clock {
    font-weight: 400;
    font-size: 13px;
    opacity: 0.9;
  }

  /* ── Toolbar ── */
  .toolbar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--card-border-dim);
    flex-wrap: wrap;
  }
  .toolbar .group {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .toolbar .group-label {
    font-size: 11px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-right: 2px;
  }
  .toolbar .spacer { flex: 1; }
  .toolbar button {
    background: var(--panel);
    color: var(--text);
    border: 1px solid var(--card-border-dim);
    padding: 4px 12px;
    border-radius: 4px;
    font-family: inherit;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s, color 0.15s;
  }
  .toolbar button:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .toolbar button.active {
    background: var(--primary);
    border-color: var(--accent);
    color: var(--header-text);
  }
  .toolbar button.refresh-btn {
    border-color: var(--green);
    color: var(--green);
  }
  .toolbar button.refresh-btn:hover {
    background: var(--green);
    color: var(--surface);
  }
  .toolbar .status {
    font-size: 11px;
    color: var(--dim);
  }

  /* ── Grid ── */
  .grid {
    display: grid;
    grid-template-columns: repeat(var(--cols), minmax(0, 420px));
    gap: 12px 16px;
    padding: 16px 20px;
    flex: 1;
    justify-content: center;
  }

  /* ── Card (matches Textual ServerCard: border round $primary, bg $panel) ── */
  .card {
    background: var(--panel);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    padding: 14px 18px;
    min-height: 100px;
    transition: border-color 0.2s;
  }
  .card:hover {
    border-color: var(--accent);
  }
  .card.card-error-border {
    border-color: var(--red);
    border-width: 2px;
    box-shadow: 0 0 8px rgba(226, 76, 94, 0.3);
  }
  .card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 2px;
  }
  .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .dot-green { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .dot-red   { background: var(--red);   box-shadow: 0 0 6px var(--red); }
  .dot-dim   { background: var(--dim);   opacity: 0.5; }
  .card-name {
    font-weight: 700;
    font-size: 14px;
    color: var(--text-bold);
  }
  .card-error {
    color: var(--red);
    font-size: 12px;
    margin-left: 4px;
  }
  .card-url {
    color: var(--dim);
    font-size: 11px;
    margin-bottom: 0;
    padding-left: 18px;
  }
  .card-web-link {
    display: inline-block;
    font-size: 11px;
    padding-left: 18px;
    margin-bottom: 4px;
  }
  .card-web-link a {
    color: var(--accent);
    text-decoration: none;
  }
  .card-web-link a:hover {
    text-decoration: underline;
  }
  .card-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: auto;
    white-space: nowrap;
  }
  .card-poll {
    color: var(--dim);
    font-size: 10px;
  }
  .card-updated {
    color: var(--dim);
    font-size: 10px;
  }
  .card-waiting {
    color: var(--dim);
    font-size: 13px;
    font-style: italic;
  }

  /* ── Metric rows ── */
  .metric {
    display: flex;
    align-items: baseline;
    gap: 8px;
    padding: 2px 0;
    font-size: 13px;
  }
  .metric-label {
    color: var(--dim);
    min-width: 160px;
    flex-shrink: 0;
  }
  .metric-value {
    font-weight: 600;
    white-space: nowrap;
  }
  .metric-spark {
    color: var(--dim);
    font-size: 12px;
    letter-spacing: 1px;
  }

  /* ── Footer (matches Textual Footer: key badges + descriptions) ── */
  .footer {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 5px 20px;
    background: var(--footer-bg);
    border-top: 1px solid var(--card-border-dim);
    font-size: 12px;
    color: var(--footer-text);
    flex-wrap: wrap;
  }
  .footer .binding {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .footer kbd {
    display: inline-block;
    background: var(--footer-key-bg);
    color: var(--footer-key-text);
    padding: 1px 6px;
    border-radius: 3px;
    font-family: inherit;
    font-size: 11px;
    font-weight: 600;
    min-width: 18px;
    text-align: center;
  }
  .footer .binding-label {
    color: var(--dim);
    font-size: 11px;
  }

  /* ── Command Palette (matches Textual Ctrl+P) ── */
  .palette-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    z-index: 100;
    justify-content: center;
    align-items: flex-start;
    padding-top: 80px;
  }
  .palette-overlay.open { display: flex; }
  .palette {
    background: var(--panel);
    border: 1px solid var(--accent);
    border-radius: 8px;
    width: min(480px, 90vw);
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    overflow: hidden;
  }
  .palette-input {
    width: 100%;
    padding: 10px 14px;
    background: var(--surface);
    color: var(--text);
    border: none;
    border-bottom: 1px solid var(--card-border-dim);
    font-family: inherit;
    font-size: 14px;
    outline: none;
  }
  .palette-input::placeholder { color: var(--dim); }
  .palette-list {
    max-height: 320px;
    overflow-y: auto;
  }
  .palette-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 14px;
    cursor: pointer;
    font-size: 13px;
    transition: background 0.1s;
  }
  .palette-item:hover,
  .palette-item.selected {
    background: var(--primary);
    color: var(--header-text);
  }
  .palette-item .pi-key {
    display: inline-block;
    background: var(--footer-key-bg);
    color: var(--footer-key-text);
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    min-width: 20px;
    text-align: center;
    flex-shrink: 0;
  }
  .palette-item.selected .pi-key {
    background: var(--header-text);
    color: var(--primary);
  }
  .palette-item .pi-label { flex: 1; }
  .palette-item .pi-desc {
    color: var(--dim);
    font-size: 11px;
  }
  .palette-item.selected .pi-desc { color: rgba(255,255,255,0.7); }

  /* ── Mini Player ── */
  body.mini-mode .toolbar,
  body.mini-mode .grid,
  body.mini-mode .footer,
  body.mini-mode .palette-overlay {
    display: none !important;
  }
  body.mini-mode {
    min-height: 0;
    height: auto;
    background: transparent;
  }
  body.mini-mode .header {
    border-radius: 10px;
    margin: 4px;
    padding: 8px 16px;
    cursor: pointer;
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    user-select: none;
    font-size: 13px;
  }
  body.mini-mode .header:hover {
    filter: brightness(1.15);
  }

  /* ── Responsive ── */
  @media (max-width: 600px) {
    .grid { grid-template-columns: 1fr !important; }
  }
</style>
</head>
<body>

<!-- Header / Status Banner -->
<div class="header" id="header">
  <span><span id="header-title">Server Monitor</span><span class="status-detail" id="header-detail"></span></span>
  <span class="clock" id="clock"></span>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <div class="group">
    <span class="group-label">Columns</span>
    <button data-cols="1">1</button>
    <button data-cols="2" class="active">2</button>
    <button data-cols="3">3</button>
  </div>
  <div class="group">
    <span class="group-label">Theme</span>
    <button id="theme-toggle">Light</button>
  </div>
  <div class="group">
    <button class="refresh-btn" id="refresh-btn">Refresh</button>
  </div>
  <div class="spacer"></div>
  <div class="group">
    <a href="/help.html" style="color:var(--accent);font-size:12px;text-decoration:none;">Help</a>
  </div>
</div>

<!-- Server cards -->
<div class="grid" id="grid"></div>

<!-- Command palette overlay (matches Textual Ctrl+P) -->
<div class="palette-overlay" id="palette-overlay">
  <div class="palette" id="palette">
    <input class="palette-input" id="palette-input" type="text"
           placeholder="Type a command..." autocomplete="off" spellcheck="false">
    <div class="palette-list" id="palette-list"></div>
  </div>
</div>

<!-- Footer (matches Textual Footer: keybinding badges) -->
<div class="footer">
  <div class="binding"><kbd>^P</kbd> <span class="binding-label">Command Palette</span></div>
  <div class="binding"><kbd>R</kbd> <span class="binding-label">Refresh Now</span></div>
  <div class="binding"><kbd>1</kbd> <span class="binding-label">1 Column</span></div>
  <div class="binding"><kbd>2</kbd> <span class="binding-label">2 Columns</span></div>
  <div class="binding"><kbd>3</kbd> <span class="binding-label">3 Columns</span></div>
  <div class="binding"><kbd>T</kbd> <span class="binding-label">Toggle Theme</span></div>
  <div class="binding"><kbd>M</kbd> <span class="binding-label">Mini Player</span></div>
</div>

<script>
(function () {
  "use strict";

  const SPARKLINE_CHARS = "\u2581\u2582\u2583\u2584\u2585\u2586\u2587\u2588";
  const POLL_MS = 3000;
  const VALID_COLORS = new Set(["red", "green", "yellow", "cyan", "magenta", "blue", "white"]);

  const grid = document.getElementById("grid");
  const clockEl = document.getElementById("clock");
  const themeBtn = document.getElementById("theme-toggle");
  const refreshBtn = document.getElementById("refresh-btn");
  const headerEl = document.getElementById("header");
  const headerTitle = document.getElementById("header-title");
  const headerDetail = document.getElementById("header-detail");

  // ── Mini Player mode ─────────────────────────────────────────────────────

  let miniMode = new URLSearchParams(window.location.search).has("mini")
                 || localStorage.getItem("sm-mini") === "true";

  let miniPopup = null;

  function setMiniMode(on) {
    miniMode = on;
    document.body.classList.toggle("mini-mode", on);
    localStorage.setItem("sm-mini", on ? "true" : "false");
  }

  setMiniMode(miniMode);

  headerEl.addEventListener("click", () => {
    if (miniMode) setMiniMode(false);
  });

  function toggleMini() {
    // If full view, open a small popup and stay on full view
    if (!miniMode) {
      const url = window.location.origin + "/?mini";
      miniPopup = window.open(url, "sm-mini", "width=420,height=56,resizable=yes,scrollbars=no,toolbar=no,menubar=no,location=no,status=no");
    } else {
      // In mini mode (popup), open full dashboard and close self
      window.open(window.location.origin + "/", "_blank");
      window.close();
    }
  }

  // ── Clock (matches Textual Header show_clock=True) ──────────────────────

  function updateClock() {
    const now = new Date();
    clockEl.textContent = now.toLocaleTimeString("en-US", {
      hour: "2-digit", minute: "2-digit", second: "2-digit"
    });
  }
  updateClock();
  setInterval(updateClock, 1000);

  // ── Theme toggle ────────────────────────────────────────────────────────

  const savedTheme = localStorage.getItem("sm-theme") || "dark";
  setTheme(savedTheme);

  themeBtn.addEventListener("click", () => {
    const current = document.documentElement.getAttribute("data-theme");
    setTheme(current === "dark" ? "light" : "dark");
  });

  function setTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("sm-theme", theme);
    themeBtn.textContent = theme === "dark" ? "Light" : "Dark";
  }

  // ── Column selection ────────────────────────────────────────────────────

  const savedCols = localStorage.getItem("sm-cols") || "2";
  setCols(savedCols);

  document.querySelectorAll(".toolbar button[data-cols]").forEach(btn => {
    btn.addEventListener("click", () => setCols(btn.dataset.cols));
  });

  function setCols(n) {
    document.documentElement.style.setProperty("--cols", n);
    localStorage.setItem("sm-cols", n);
    document.querySelectorAll(".toolbar button[data-cols]").forEach(b => {
      b.classList.toggle("active", b.dataset.cols === String(n));
    });
  }

  // ── Command Palette (matches Textual Ctrl+P) ─────────────────────────────

  const paletteOverlay = document.getElementById("palette-overlay");
  const paletteInput = document.getElementById("palette-input");
  const paletteList = document.getElementById("palette-list");
  let paletteSelected = 0;

  const COMMANDS = [
    { key: "R",  label: "Refresh Now",       desc: "Poll all servers immediately",  action: () => poll() },
    { key: "1",  label: "1 Column Layout",   desc: "Single column grid",            action: () => setCols("1") },
    { key: "2",  label: "2 Column Layout",   desc: "Two column grid",               action: () => setCols("2") },
    { key: "3",  label: "3 Column Layout",   desc: "Three column grid",             action: () => setCols("3") },
    { key: "T",  label: "Toggle Theme",      desc: "Switch between dark and light",
      action: () => { const c = document.documentElement.getAttribute("data-theme"); setTheme(c === "dark" ? "light" : "dark"); }
    },
    { key: "M",  label: "Mini Player",      desc: "Toggle compact status-only view", action: () => toggleMini() },
  ];

  function openPalette() {
    paletteOverlay.classList.add("open");
    paletteInput.value = "";
    paletteSelected = 0;
    renderPalette("");
    paletteInput.focus();
  }

  function closePalette() {
    paletteOverlay.classList.remove("open");
    paletteInput.blur();
  }

  function filteredCommands(query) {
    if (!query) return COMMANDS;
    const q = query.toLowerCase();
    return COMMANDS.filter(c =>
      c.label.toLowerCase().includes(q) ||
      c.desc.toLowerCase().includes(q) ||
      c.key.toLowerCase() === q
    );
  }

  function renderPalette(query) {
    const items = filteredCommands(query);
    if (paletteSelected >= items.length) paletteSelected = Math.max(0, items.length - 1);
    paletteList.innerHTML = items.map((c, i) => `
      <div class="palette-item${i === paletteSelected ? " selected" : ""}" data-idx="${i}">
        <span class="pi-key">${c.key}</span>
        <span class="pi-label">${c.label}</span>
        <span class="pi-desc">${c.desc}</span>
      </div>
    `).join("");
    // Click handler
    paletteList.querySelectorAll(".palette-item").forEach(el => {
      el.addEventListener("click", () => {
        const idx = parseInt(el.dataset.idx);
        const cmd = items[idx];
        if (cmd) { closePalette(); cmd.action(); }
      });
    });
  }

  paletteInput.addEventListener("input", () => {
    paletteSelected = 0;
    renderPalette(paletteInput.value);
  });

  paletteInput.addEventListener("keydown", (e) => {
    const items = filteredCommands(paletteInput.value);
    if (e.key === "ArrowDown") {
      e.preventDefault();
      paletteSelected = Math.min(paletteSelected + 1, items.length - 1);
      renderPalette(paletteInput.value);
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      paletteSelected = Math.max(paletteSelected - 1, 0);
      renderPalette(paletteInput.value);
    } else if (e.key === "Enter") {
      e.preventDefault();
      const cmd = items[paletteSelected];
      if (cmd) { closePalette(); cmd.action(); }
    } else if (e.key === "Escape") {
      closePalette();
    }
  });

  paletteOverlay.addEventListener("click", (e) => {
    if (e.target === paletteOverlay) closePalette();
  });

  // ── Keyboard shortcuts (matches Textual BINDINGS) ───────────────────────

  document.addEventListener("keydown", (e) => {
    // Ctrl+P opens palette
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "p") {
      e.preventDefault();
      openPalette();
      return;
    }
    if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
    switch (e.key.toLowerCase()) {
      case "r": poll(); break;
      case "m": toggleMini(); break;
      case "1": setCols("1"); break;
      case "2": setCols("2"); break;
      case "3": setCols("3"); break;
      case "t": {
        const cur = document.documentElement.getAttribute("data-theme");
        setTheme(cur === "dark" ? "light" : "dark");
        break;
      }
    }
  });

  // ── Refresh button ──────────────────────────────────────────────────────

  refreshBtn.addEventListener("click", () => poll());

  // ── LAN URL rewriting ──────────────────────────────────────────────────

  let lanIP = "";

  function lanUrl(url) {
    if (!lanIP || !url) return url;
    return url.replace(/\b127\.0\.0\.1\b/g, lanIP).replace(/\blocalhost\b/g, lanIP);
  }

  // ── Rendering helpers (ported from metric_row.py) ───────────────────────

  function sparkline(values) {
    if (!values || values.length === 0) return "";
    const nums = values.slice(-12).map(Number);
    const lo = Math.min(...nums);
    const hi = Math.max(...nums);
    const span = hi !== lo ? hi - lo : 1;
    return nums.map(v => {
      const idx = Math.min(Math.floor((v - lo) / span * 7), 7);
      return SPARKLINE_CHARS[Math.max(idx, 0)];
    }).join("");
  }

  function computeColor(metric) {
    const explicit = metric.color;
    if (explicit && VALID_COLORS.has(explicit)) return explicit;
    const v = metric.value;
    if (typeof v === "number") {
      if (metric.warn_above != null && v > metric.warn_above) return "red";
      if (metric.warn_below != null && v < metric.warn_below) return "red";
    }
    return "green";
  }

  function formatValue(value) {
    if (typeof value === "number") {
      if (Number.isInteger(value)) return value.toLocaleString("en-US");
      return value.toLocaleString("en-US", { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    }
    return String(value);
  }

  function escapeHtml(s) {
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  function formatUpdated(epoch) {
    if (!epoch) return "";
    const d = new Date(epoch * 1000);
    return d.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  }

  function cardMeta(srv) {
    const parts = [];
    if (srv.last_updated) parts.push(`<span class="card-updated">${formatUpdated(srv.last_updated)}</span>`);
    if (srv.poll_every) parts.push(`<span class="card-poll">${srv.poll_every}s</span>`);
    if (parts.length === 0) return "";
    return `<span class="card-meta">${parts.join("")}</span>`;
  }

  // ── Card rendering (matches ServerCard render states) ────────────────────

  function webLinkHtml(srv) {
    if (!srv.web_url) return "";
    return `<div class="card-web-link"><a href="${escapeHtml(srv.web_url)}" target="_blank">${escapeHtml(srv.web_url)}</a></div>`;
  }

  function renderCard(srv) {
    const card = document.createElement("div");
    card.className = "card";

    // State 1: waiting (no data yet)
    if (srv.metrics == null && srv.error == null) {
      card.innerHTML = `
        <div class="card-header">
          <span class="dot dot-dim"></span>
          <span class="card-name" style="color:var(--cyan)">${escapeHtml(srv.name)}</span>
          <span class="card-waiting">waiting\u2026</span>
          ${cardMeta(srv)}
        </div>
        ${srv.url ? `<div class="card-url">${escapeHtml(lanUrl(srv.url))}</div>` : ""}
        ${webLinkHtml(srv)}
      `;
      return card;
    }

    const hasMetrics = srv.metrics && srv.metrics.length > 0;
    const hasError = !!srv.error;

    // State 2: error with no metrics
    if (hasError && !hasMetrics) {
      card.classList.add("card-error-border");
      card.innerHTML = `
        <div class="card-header">
          <span class="dot dot-red"></span>
          <span class="card-name">${escapeHtml(srv.name)}</span>
          <span class="card-error">${escapeHtml(srv.error)}</span>
          ${cardMeta(srv)}
        </div>
        ${srv.url ? `<div class="card-url">${escapeHtml(lanUrl(srv.url))}</div>` : ""}
        ${webLinkHtml(srv)}
      `;
      return card;
    }

    // State 3: healthy (possibly with warning)
    let headerExtra = "";
    if (hasError) {
      card.classList.add("card-error-border");
      headerExtra = `<span style="color:var(--yellow);font-size:12px;margin-left:4px">${escapeHtml(srv.error)}</span>`;
    }
    let metricsHtml = "";
    for (const m of srv.metrics) {
      const color = computeColor(m);
      const display = formatValue(m.value);
      const unit = m.unit ? ` ${escapeHtml(m.unit)}` : "";
      const spark = sparkline(m.sparkline_history);
      metricsHtml += `
        <div class="metric">
          <span class="metric-label">${escapeHtml(m.label || m.key || "?")}</span>
          <span class="metric-value" style="color:var(--${color})">${display}${unit}</span>
          ${spark ? `<span class="metric-spark">${spark}</span>` : ""}
        </div>
      `;
    }

    card.innerHTML = `
      <div class="card-header">
        <span class="dot dot-green"></span>
        <span class="card-name">${escapeHtml(srv.name)}</span>
        ${headerExtra}
        ${cardMeta(srv)}
      </div>
      ${srv.url ? `<div class="card-url">${escapeHtml(lanUrl(srv.url))}</div>` : ""}
      ${webLinkHtml(srv)}
      ${metricsHtml}
    `;
    return card;
  }

  // ── Polling ──────────────────────────────────────────────────────────────

  async function poll() {
    try {
      const resp = await fetch("/api/status");
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();

      if (data.lan_ip) lanIP = data.lan_ip;

      // Update status banner
      const errorServers = data.servers.filter(s => !!s.error);
      const total = data.servers.length;
      const healthy = total - errorServers.length;

      headerEl.classList.remove("status-ok", "status-error");
      if (total === 0) {
        headerTitle.textContent = "Server Monitor";
        headerDetail.textContent = "";
      } else if (errorServers.length === 0) {
        headerEl.classList.add("status-ok");
        headerTitle.textContent = "All Systems OK";
        headerDetail.textContent = `${healthy}/${total} servers healthy`;
      } else {
        headerEl.classList.add("status-error");
        const names = errorServers.map(s => s.name).join(", ");
        headerTitle.textContent = `${errorServers.length} Server${errorServers.length > 1 ? "s" : ""} Down`;
        headerDetail.textContent = names;
      }

      grid.innerHTML = "";
      for (const srv of data.servers) {
        grid.appendChild(renderCard(srv));
      }

      if (data.servers.length === 0) {
        grid.innerHTML = '<div style="color:var(--dim);padding:40px;text-align:center">No servers configured.</div>';
      }
    } catch (err) {
      console.error("Poll error:", err.message);
    }
  }

  // Initial poll + interval
  poll();
  setInterval(poll, POLL_MS);
})();
</script>
</body>
</html>
