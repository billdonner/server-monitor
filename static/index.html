<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Server Monitor</title>
<style>
  :root {
    --cols: 2;
    --bg: #1a1a2e;
    --card-bg: #16213e;
    --card-border: #0f3460;
    --text: #e0e0e0;
    --dim: #666;
    --green: #00e676;
    --red: #ff5252;
    --yellow: #ffd740;
    --cyan: #18ffff;
    --magenta: #ea80fc;
    --blue: #448aff;
    --white: #e0e0e0;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'Menlo', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* -- Toolbar -- */
  .toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    background: #0f0f23;
    border-bottom: 1px solid var(--card-border);
  }
  .toolbar h1 {
    font-size: 16px;
    font-weight: 600;
    color: var(--cyan);
    margin-right: auto;
  }
  .toolbar button {
    background: var(--card-bg);
    color: var(--text);
    border: 1px solid var(--card-border);
    padding: 6px 14px;
    border-radius: 4px;
    font-family: inherit;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
  }
  .toolbar button:hover { background: #1a2a50; }
  .toolbar button.active {
    background: #0f3460;
    border-color: var(--cyan);
    color: var(--cyan);
  }
  .toolbar .status {
    font-size: 12px;
    color: var(--dim);
  }

  /* -- Grid -- */
  .grid {
    display: grid;
    grid-template-columns: repeat(var(--cols), 1fr);
    gap: 16px;
    padding: 20px;
  }

  /* -- Card -- */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 8px;
    padding: 16px 20px;
    min-height: 120px;
  }
  .card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }
  .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .dot-green { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .dot-red { background: var(--red); box-shadow: 0 0 6px var(--red); }
  .dot-dim { background: var(--dim); }
  .card-name {
    font-weight: 600;
    font-size: 14px;
  }
  .card-error {
    color: var(--red);
    font-size: 13px;
    margin-left: 8px;
  }
  .card-url {
    color: var(--dim);
    font-size: 12px;
    margin-bottom: 10px;
    padding-left: 18px;
  }
  .card-waiting {
    color: var(--dim);
    font-size: 13px;
    font-style: italic;
  }

  /* -- Metric rows -- */
  .metric {
    display: flex;
    align-items: baseline;
    gap: 8px;
    padding: 3px 0;
    font-size: 13px;
  }
  .metric-label {
    color: var(--dim);
    min-width: 160px;
    flex-shrink: 0;
  }
  .metric-value {
    font-weight: 500;
    white-space: nowrap;
  }
  .metric-spark {
    color: var(--dim);
    font-size: 12px;
    letter-spacing: 1px;
  }

  /* Responsive: force 1 col on narrow screens */
  @media (max-width: 600px) {
    .grid { grid-template-columns: 1fr !important; }
  }
</style>
</head>
<body>

<div class="toolbar">
  <h1>Server Monitor</h1>
  <button data-cols="1">1 col</button>
  <button data-cols="2" class="active">2 cols</button>
  <button data-cols="3">3 cols</button>
  <span class="status" id="last-update"></span>
</div>

<div class="grid" id="grid"></div>

<script>
(function () {
  "use strict";

  const SPARKLINE_CHARS = "\u2581\u2582\u2583\u2584\u2585\u2586\u2587\u2588";
  const POLL_MS = 3000;
  const VALID_COLORS = new Set(["red", "green", "yellow", "cyan", "magenta", "blue", "white"]);

  const grid = document.getElementById("grid");
  const lastUpdateEl = document.getElementById("last-update");

  // -- Column selection -------------------------------------------------------

  const savedCols = localStorage.getItem("sm-cols") || "2";
  setCols(savedCols);

  document.querySelectorAll(".toolbar button[data-cols]").forEach(btn => {
    btn.addEventListener("click", () => setCols(btn.dataset.cols));
  });

  function setCols(n) {
    document.documentElement.style.setProperty("--cols", n);
    localStorage.setItem("sm-cols", n);
    document.querySelectorAll(".toolbar button[data-cols]").forEach(b => {
      b.classList.toggle("active", b.dataset.cols === String(n));
    });
  }

  // -- Rendering helpers (ported from metric_row.py) --------------------------

  function sparkline(values) {
    if (!values || values.length === 0) return "";
    const nums = values.slice(-20).map(Number);
    const lo = Math.min(...nums);
    const hi = Math.max(...nums);
    const span = hi !== lo ? hi - lo : 1;
    return nums.map(v => {
      const idx = Math.min(Math.floor((v - lo) / span * 7), 7);
      return SPARKLINE_CHARS[Math.max(idx, 0)];
    }).join("");
  }

  function computeColor(metric) {
    const explicit = metric.color;
    if (explicit && VALID_COLORS.has(explicit)) return explicit;
    const v = metric.value;
    if (typeof v === "number") {
      if (metric.warn_above != null && v > metric.warn_above) return "red";
      if (metric.warn_below != null && v < metric.warn_below) return "red";
    }
    return "green";
  }

  function formatValue(value) {
    if (typeof value === "number") {
      if (Number.isInteger(value)) return value.toLocaleString("en-US");
      return value.toLocaleString("en-US", { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    }
    return String(value);
  }

  function escapeHtml(s) {
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  // -- Card rendering ---------------------------------------------------------

  function renderCard(srv) {
    const card = document.createElement("div");
    card.className = "card";

    // No data yet
    if (srv.metrics == null && srv.error == null) {
      card.innerHTML = `
        <div class="card-header">
          <span class="dot dot-dim"></span>
          <span class="card-name" style="color:var(--cyan)">${escapeHtml(srv.name)}</span>
          <span class="card-waiting">waiting\u2026</span>
        </div>
        ${srv.url ? `<div class="card-url">${escapeHtml(srv.url)}</div>` : ""}
      `;
      return card;
    }

    const hasMetrics = srv.metrics && srv.metrics.length > 0;
    const hasError = !!srv.error;

    // Error with no metrics
    if (hasError && !hasMetrics) {
      card.innerHTML = `
        <div class="card-header">
          <span class="dot dot-red"></span>
          <span class="card-name">${escapeHtml(srv.name)}</span>
          <span class="card-error">${escapeHtml(srv.error)}</span>
        </div>
        ${srv.url ? `<div class="card-url">${escapeHtml(srv.url)}</div>` : ""}
      `;
      return card;
    }

    // Healthy (possibly with warning error)
    let headerExtra = "";
    if (hasError) {
      headerExtra = `<span style="color:var(--yellow);font-size:13px;margin-left:8px">${escapeHtml(srv.error)}</span>`;
    }
    let metricsHtml = "";
    for (const m of srv.metrics) {
      const color = computeColor(m);
      const display = formatValue(m.value);
      const unit = m.unit ? ` ${escapeHtml(m.unit)}` : "";
      const spark = sparkline(m.sparkline_history);
      metricsHtml += `
        <div class="metric">
          <span class="metric-label">${escapeHtml(m.label || m.key || "?")}</span>
          <span class="metric-value" style="color:var(--${color})">${display}${unit}</span>
          ${spark ? `<span class="metric-spark">${spark}</span>` : ""}
        </div>
      `;
    }

    card.innerHTML = `
      <div class="card-header">
        <span class="dot dot-green"></span>
        <span class="card-name">${escapeHtml(srv.name)}</span>
        ${headerExtra}
      </div>
      ${srv.url ? `<div class="card-url">${escapeHtml(srv.url)}</div>` : ""}
      ${metricsHtml}
    `;
    return card;
  }

  // -- Polling ----------------------------------------------------------------

  async function poll() {
    try {
      const resp = await fetch("/api/status");
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();

      grid.innerHTML = "";
      for (const srv of data.servers) {
        grid.appendChild(renderCard(srv));
      }

      if (data.servers.length === 0) {
        grid.innerHTML = '<div style="color:var(--dim);padding:40px;text-align:center">No servers configured.</div>';
      }

      const now = new Date();
      lastUpdateEl.textContent = `Updated ${now.toLocaleTimeString()}`;
    } catch (err) {
      lastUpdateEl.textContent = `Error: ${err.message}`;
    }
  }

  // Initial poll + interval
  poll();
  setInterval(poll, POLL_MS);
})();
</script>
</body>
</html>
